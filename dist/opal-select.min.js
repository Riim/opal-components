!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rionite"),require("cellx"),require("cellx-indexed-collections")):"function"==typeof define&&define.amd?define(["rionite","cellx","cellx-indexed-collections"],t):"object"==typeof exports?exports["opal-select"]=t(require("rionite"),require("cellx"),require("cellx-indexed-collections")):e["opal-select"]=t(e.rionite,e.cellx,e["cellx-indexed-collections"])}(this,function(e,t,o){return function(e){function t(n){if(o[n])return o[n].exports;var i=o[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}({0:function(e,t,o){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function n(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),i=this&&this.__decorate||function(e,t,o,n){var i,s=arguments.length,l=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,n);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(l=(s<3?i(l):s>3?i(t,o,l):i(t,o))||l);return s>3&&l&&Object.defineProperty(t,o,l),l};Object.defineProperty(t,"__esModule",{value:!0}),o(65),o(78);var s=o(2),l=o(3),r=o(1),a=o(10),c=o(19),p=o(35),u=o(10);t.OpalSelectOption=u.default;var d=s.Utils.nextUID,h=s.Utils.nextTick,f=r.Components.RtIfThen,m=r.Components.RtRepeat,v=Array.prototype.map,_={value:"value",text:"text",disabled:"disabled"},y={value:"value",text:"text",disabled:"disabled"},b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._opened=!1,t._onсeFocusedAfterLoading=!1,t}return n(t,e),t.prototype.initialize=function(){var e=this.props;if(e.datalistKeypath){var t=this.ownerComponent||window,o=Function("return this."+e.datalistKeypath+";");s.define(this,"dataList",function(){return o.call(t)});var n=e.datalistItemSchema;this._dataListItemValueFieldName=n.value||_.value,this._dataListItemTextFieldName=n.text||_.text,this._dataListItemDisabledFieldName=n.disabled||_.disabled}else this.dataList=null;var i=e.viewModelItemSchema;this._viewModelItemValueFieldName=i.value||y.value,this._viewModelItemTextFieldName=i.text||y.text,this._viewModelItemDisabledFieldName=i.disabled||y.disabled;var r;if(e.viewModelKeypath){if(!(r=Function("return this."+e.viewModelKeypath+";").call(this.ownerComponent||window)))throw new TypeError("viewModel is not defined")}else r=new l.IndexedList(void 0,{indexes:[this._viewModelItemValueFieldName]});s.define(this,{viewModel:r,options:function(){return this.optionElements?v.call(this.optionElements,function(e){return e.$c}):[]},text:function(){var e=this;return this.viewModel.map(function(t){return t[e._viewModelItemTextFieldName]}).join(", ")||this.props.placeholder}})},t.prototype.ready=function(){var e=this;this.optionElements=this.element.getElementsByClassName("opal-select-option");var t=this.props;if(t.viewModel)this._updateOptions();else{var o=t.value,n=void 0;if(o){if(!Array.isArray(o))throw new TypeError("value must be an array");if(o.length)if(t.multiple)n=this.options.filter(function(e){return-1!=o.indexOf(e.value)});else{o=o[0];var i=this.options.find(function(e){return e.value==o});n=i?[i]:[]}else n=[]}else if(t.multiple)n=this.options.filter(function(e){return e.selected});else{var i=this.options.find(function(e){return e.selected});n=i?[i]:[]}n.length&&this.viewModel.addRange(n.map(function(t){return o={},o[e._viewModelItemValueFieldName]=t.value,o[e._viewModelItemTextFieldName]=t.text,o;var o})),o&&this._updateOptions()}},t.prototype.elementAttached=function(){this.listenTo(this.viewModel,"change",this._onViewModelChange)},t.prototype.propertyChanged=function(e,t){"focused"==e&&(t?(this._documentKeyDownListening||(this._documentKeyDownListening=this.listenTo(document,"keydown",this._onDocumentKeyDown)),this.focus()):(this._opened||(this._documentKeyDownListening.stop(),this._documentKeyDownListening=null),this.blur()))},t.prototype._onViewModelChange=function(){this._updateOptions()},t.prototype._updateOptions=function(){var e=this,t=this.viewModel;this.options.forEach(function(o){var n=t.get(o.value,e._viewModelItemValueFieldName);n?(o.selected=!0,o.disabled=n[e._viewModelItemDisabledFieldName]):o.selected=!1})},t.prototype.open=function(){var e=this;if(this._opened)return!1;this._opened=!0,this._valueAtOpening=this.viewModel.map(function(t){return t[e._viewModelItemValueFieldName]}),this._documentFocusListening=this.listenTo(document,"focus",this._onDocumentFocus,this,!0),this._documentKeyDownListening||(this._documentKeyDownListening=this.listenTo(document,"keydown",this._onDocumentKeyDown)),this.$("button").check(),this.$("menu").open();var t=this.$("loaded-list");t&&h(function(){t.checkLoading()});var o=this.$("filtered-list");return o?o.focus():this._focusOptions(),!0},t.prototype.close=function(){var e=this;return!!this._opened&&(this._opened=!1,this._documentFocusListening.stop(),this.props.focused||(this._documentKeyDownListening.stop(),this._documentKeyDownListening=null),this.$("button").uncheck(),this.$("menu").close(),this.props.multiple&&(c.default(this.viewModel.map(function(t){return t[e._viewModelItemValueFieldName]}),this._valueAtOpening)||this.emit("change")),!0)},t.prototype.toggle=function(e){return void 0!==e?e?this.open():!this.close():this.open()||!this.close()},t.prototype._onDocumentFocus=function(e){this.element.contains(e.target.parentNode)||this.close()},t.prototype._onDocumentKeyDown=function(e){switch(e.which){case 32:e.preventDefault(),this._opened?this.props.focused&&this.close():this.open();break;case 38:if(e.preventDefault(),this._opened){if(document.activeElement==document.body)this._focusOptions()&&document.body.classList.remove("_no-focus-highlight");else for(var t=this.options,o=1,n=t.length;o<n;o++)if(t[o].props.focused){do{var i=t[--o];if(!i.props.disabled){document.body.classList.remove("_no-focus-highlight"),i.focus();break}}while(o);break}}else this.open();break;case 40:if(e.preventDefault(),this._opened){if(document.activeElement==document.body)this._focusOptions()&&document.body.classList.remove("_no-focus-highlight");else for(var t=this.options,o=0,n=t.length-1;o<n;o++)if(t[o].props.focused){do{var i=t[++o];if(!i.props.disabled){document.body.classList.remove("_no-focus-highlight"),i.focus();break}}while(o<n);break}}else this.open();break;case 27:e.preventDefault(),this.close(),this.focus()}},t.prototype._focusOptions=function(){for(var e,t=this.options,o=0,n=t.length;o<n;o++){var i=t[o];if(!i.props.disabled){if(i.selected){e=i;break}e||(e=i)}}return!!e&&(e.focus(),!0)},t.prototype.focus=function(){return this.$("button").focus(),this},t.prototype.blur=function(){return this.$("button").blur(),this},t}(r.Component);b.OpalSelectOption=a.default,b=i([r.d.Component({elementIs:"opal-select",props:{viewType:String,size:"m",multiple:{default:!1,readonly:!0},datalistKeypath:{type:String,readonly:!0},datalistItemSchema:{type:eval,default:_,readonly:!0},value:eval,viewModelKeypath:{type:String,readonly:!0},viewModelItemSchema:{type:eval,default:y,readonly:!0},text:String,placeholder:r.getText.t("Не выбрано"),tabIndex:0,focused:!1,disabled:!1},bemlTemplate:p,events:{":component":{"property-value-change":function(e){var t=this.viewModel,o=e.value;if(o){if(!Array.isArray(o))throw new TypeError("value must be an array");if(o.length){var n=this._viewModelItemValueFieldName,i=this._viewModelItemTextFieldName;this.props.multiple?this.options.forEach(function(e){var s=e.value;if(-1!=o.indexOf(s))t.contains(s,n)||t.add((r={},r[n]=s,r[i]=e.text,r));else{var l=t.get(s,n);l&&t.remove(l)}var r}):(o=o[0],t.length&&o==t.get(0)[n]||!this.options.some(function(e){return e.value==o&&(t.set(0,(s={},s[n]=o,s[i]=e.text,s)),!0);var s})&&t.length&&t.clear())}else t.clear()}else t.clear()}},button:{focus:function(){this.props.focused=!0,this.emit("focus")},blur:function(){this.props.focused=!1,this.emit("blur")},click:function(e){e.target.checked?this.open():this.close()}},menu:{"property-opened-change":function(e){e.value||this.close()},"<opal-select-option>select":function(e){var t=this.viewModel,o=(n={},n[this._viewModelItemValueFieldName]=e.target.value,n[this._viewModelItemTextFieldName]=e.target.text,n);this.props.multiple?t.add(o):(t.length?t.set(0,o):t.add(o),this.close(),this.focus(),this.emit("change"));var n},"<opal-select-option>deselect":function(e){this.props.multiple?this.viewModel.remove(this.viewModel.get(e.target.value,this._viewModelItemValueFieldName)):(e.target.select(),this.close(),this.focus())},"<opal-text-input>confirm":function(e){var t=e.target;if(t===this.$("new-item-input")){var o="_"+Math.floor(1e9*Math.random())+"_"+d(),n=t.value,i=this.dataList;i&&i.add((a={},a[this._dataListItemValueFieldName]=o,a[this._dataListItemTextFieldName]=n,a)),t.clear();var s=this.$("loaded-list");s&&(s.props.query=""),this.emit("input");var l=this.viewModel,r=(c={},c[this._viewModelItemValueFieldName]=o,c[this._viewModelItemTextFieldName]=n,c);this.props.multiple?l.add(r):(l.length?l.set(0,r):l.add(r),this.close(),this.focus(),this.emit("change"));var a,c}},"<*>change":function(e){if(e.target instanceof f||e.target instanceof m)return this._options.pull(),this._updateOptions(),!1}},"loaded-list":{loaded:function(){var e=this;this._onсeFocusedAfterLoading||(this._onсeFocusedAfterLoading=!0,h(function(){var t=e.$("filtered-list");if(t){var o=t.$("query-input");o&&document.activeElement==o.$("text-field")?(e._focusOptions(),h(function(){t.focus()})):e._focusOptions()}else e._focusOptions()}))}}}})],b),t.default=b},1:function(t,o){t.exports=e},2:function(e,o){e.exports=t},3:function(e,t){e.exports=o},10:function(e,t,o){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function n(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),i=this&&this.__decorate||function(e,t,o,n){var i,s=arguments.length,l=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,n);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(l=(s<3?i(l):s>3?i(t,o,l):i(t,o))||l);return s>3&&l&&Object.defineProperty(t,o,l),l};Object.defineProperty(t,"__esModule",{value:!0}),o(66);var s=o(2),l=o(1),r=o(36),a=s.Utils.nextTick,c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.initialize=function(){s.define(this,{_tabIndex:function(){return this.props.disabled?-1:this.props.tabIndex}})},t.prototype.propertyChanged=function(e,t){"focused"==e&&this[t?"focus":"blur"]()},t.prototype.click=function(){return this.emit(this.toggle()?"select":"deselect"),this},Object.defineProperty(t.prototype,"value",{get:function(){var e=this.props;return null===e.value?e.text:e.value},set:function(e){this.props.value=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"text",{get:function(){return this.props.text.trim()||" "},set:function(e){this.props.text=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{get:function(){return this.props.selected},set:function(e){this.props.selected=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"disabled",{get:function(){return this.props.disabled},set:function(e){this.props.disabled=e},enumerable:!0,configurable:!0}),t.prototype.select=function(){return!this.props.selected&&(this.props.selected=!0,!0)},t.prototype.deselect=function(){return!!this.props.selected&&(this.props.selected=!1,!0)},t.prototype.toggle=function(e){return this.props.selected=void 0===e?!this.props.selected:e},t.prototype.focus=function(){return this.$("control").focus(),this},t.prototype.blur=function(){return this.$("control").blur(),this},t.prototype.enable=function(){return this.props.disabled=!1,this},t.prototype.disable=function(){return this.props.disabled=!0,this},t}(l.Component);c=i([l.d.Component({elementIs:"opal-select-option",props:{value:String,text:{type:String,required:!0},selected:!1,tabIndex:0,focused:!1,disabled:!1},bemlTemplate:r,events:{control:{focus:function(e){var t=this;a(function(){document.activeElement==e.target&&(t.props.focused=!0)})},blur:function(){this.props.focused=!1},click:function(e){e.preventDefault(),this.props.disabled||this.click()}}}})],c),t.default=c},19:function(e,t){"use strict";function o(e,t){var o=e.length;if(o!=t.length)return!1;for(var n=0;n<o;n++)if(e[n]!==t[n])return!1;return!0}Object.defineProperty(t,"__esModule",{value:!0}),t.default=o},35:function(e,t){e.exports="@section/inner {\nrt-content (select=.opal-select__button, cloning=no) {\nopal-button/button (\nview-type={props.viewType},\nsize={props.size},\ncheckable,\ntab-index={props.tabIndex},\ndisabled={props.disabled}\n) {\n@if-then (if=props.text, rt-silent) { '{props.text}' }\n@if-else (if=props.text, rt-silent) { '{text}' }\n' '\nsvg/icon-chevron-down (viewBox=0 0 32 18) { use (xlink:href=#opal-components__icon-chevron-down) }\n}\n}\nrt-content (select=.opal-select__menu, cloning=no) {\nopal-dropdown/menu (auto-closing) {\nrt-content (select=.opal-select__menu-content, cloning=no) {\n@if-then (if=props.datalistKeypath) {\ndiv/, menu-content {\n@if-then (if=dataList.length) {\n@repeat (for=item of dataList) {\nopal-select-option/option (\nvalue='{item |key(_dataListItemValueFieldName) }',\ntext='{item |key(_dataListItemTextFieldName) }',\ndisabled='{item |key(_dataListItemDisabledFieldName) }'\n)\n}\nrt-content/new-item-input-container // доопределяется ниже\n}\n@if-else (if=dataList.length, rt-silent) {\nopal-loader/menu-loader (shown)\n}\n}\n}\n@if-else (if=props.datalistKeypath) {\ndiv/, menu-content {\nrt-content/options (select=opal-select-option)\nrt-content/new-item-input-container (select=.opal-select__new-item-input)\n}\n}\n}\n}\n}\n}"},36:function(e,t){e.exports="@section/inner {\nbutton/control (tabindex={_tabIndex}) {\nrt-content/content (cloning=no) { '{props.text}' }\n}\n}"},65:function(e,t){e.exports=function(e){var t=e.head||e.getElementsByTagName("head")[0];if(t){var o=e.createElement("style");return o.type="text/css",o.textContent=".opal-select{position:relative;display:inline-block;vertical-align:middle}.opal-select .opal-select__button{display:block;min-width:100%}.opal-select .opal-select__icon-chevron-down{display:inline-block;margin-left:.25em;width:14px;height:14px;vertical-align:middle;transition:transform .1s linear;fill:currentColor}.opal-select .opal-select__button[size=s] .opal-select__icon-chevron-down{width:12px;height:12px}.opal-select .opal-select__button[checked] .opal-select__icon-chevron-down{-ms-transform:scaleY(-1);transform:scaleY(-1)}.opal-select .opal-select__new-item-input{display:block;margin:10px;width:auto}.opal-select .opal-popover{padding:6px 0;min-width:100px}.opal-select .opal-filtered-list .opal-filtered-list__query-input{margin:10px}.opal-select .opal-loaded-list{height:300px}",t.appendChild(o),o}return null}(document)},66:function(e,t){e.exports=function(e){var t=e.head||e.getElementsByTagName("head")[0];if(t){var o=e.createElement("style");return o.type="text/css",o.textContent=".opal-select-option{display:block}.opal-select-option .opal-select-option__control{position:relative;display:block;box-sizing:border-box;padding:7px 22px;width:100%;border:0;background:#fff;color:#000;text-align:left;text-shadow:none;white-space:nowrap;font:16px/24px Verdana,Geneva,sans-serif;font-weight:400;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}.opal-select-option .opal-select-option__content{position:relative;display:block}.opal-select-option .opal-select-option__control:hover{background:#e6e6e6}.opal-select-option .opal-select-option__control:focus{outline:none}.opal-select-option .opal-select-option__control:focus::after{position:absolute;top:2px;right:2px;bottom:2px;left:2px;box-shadow:inset 0 0 0 1px #33a0ff;content:'';pointer-events:none}.opal-select-option .opal-select-option__control:active{background:#ccc}.opal-select-option[selected] .opal-select-option__control{color:#0d87f2}.opal-select-option[disabled]{opacity:.5;pointer-events:none}.opal-select-option[disabled] .opal-select-option__control{cursor:default}",t.appendChild(o),o}return null}(document)},78:function(e,t){!function e(){document.body?document.body.insertAdjacentHTML("beforeend",'<svg xmlns="http://www.w3.org/2000/svg" style="display:none"><symbol viewBox="0 0 32 18" id="opal-components__icon-chevron-down"><path stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" fill="none" d="M2 2l14 14L30 2" xmlns="http://www.w3.org/2000/svg"/></symbol></svg>'):setTimeout(e,100)}()}})});