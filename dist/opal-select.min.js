!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rionite"),require("cellx"),require("cellx-indexed-collections")):"function"==typeof define&&define.amd?define(["rionite","cellx","cellx-indexed-collections"],t):"object"==typeof exports?exports["opal-select"]=t(require("rionite"),require("cellx"),require("cellx-indexed-collections")):e["opal-select"]=t(e.rionite,e.cellx,e["cellx-indexed-collections"])}(this,function(e,t,o){return function(e){function t(n){if(o[n])return o[n].exports;var i=o[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}({0:function(e,t,o){"use strict";o(66),o(79);var n=o(2),i=n.Utils,s=i.nextUID,l=i.nextTick,c=n.cellx,a=o(3),r=a.IndexedList,p=o(1),u=p.getText,d=p.ComponentTemplate,h=p.Component,f=p.Components,m=f.RtIfThen,v=f.RtRepeat,_=o(17),b=o(16),w=Array.prototype.map;e.exports=h.extend("opal-select",{Static:{OpalSelectOption:_,props:{type:String,size:"m",datalist:{type:String,readonly:!0},value:Object,viewModel:{type:String,readonly:!0},viewModelItemSchema:{default:{value:"value",text:"text",disabled:"disabled"},readonly:!0},text:String,placeholder:u.t("Не выбрано"),multiple:{default:!1,readonly:!0},allowInput:!1,focused:!1,tabIndex:0,disabled:!1},template:new d(o(36)),events:{button:{focusin:function(){this.props.focused=!0,this.emit("focusin")},focusout:function(){this.props.focused=!1,this.emit("focusout")},click:function(e){(e.originalEvent||e).preventDefault(),this[e.target.checked?"open":"close"]()}},menu:{close:function(){this.close()},confirminput:function(e){var t,o=e.target;if(this.props.allowInput){var n="_"+Math.floor(1e9*Math.random())+"_"+s(),i=o.value,l=this.dataList;l&&l.add({value:n,text:i}),o.clear();var c=this.loadedList;void 0===c&&(c=this.loadedList=this.$("loaded-list")),c&&(c.props.query=""),this.emit("input");var a=this.viewModel,r=(t={},t[this._viewModelItemValueFieldName]=n,t[this._viewModelItemTextFieldName]=i,t);this.props.multiple?a.add(r):(a.length?a.set(0,r):a.add(r),this.close(),this.focus(),this.emit("change"))}},change:function(e){if(e.target instanceof m||e.target instanceof v)return this._options.pull(),this._updateOptions(),!1},select:function(e){var t,o=e.target;if(o instanceof _){var n=this.viewModel,i=(t={},t[this._viewModelItemValueFieldName]=o.value,t[this._viewModelItemTextFieldName]=o.text,t);this.props.multiple?n.add(i):(n.length?n.set(0,i):n.add(i),this.close(),this.focus(),this.emit("change"))}},deselect:function(e){var t=e.target;t instanceof _&&(this.props.multiple?this.viewModel.remove(this.viewModel.get(t.value,this._viewModelItemValueFieldName)):(t.select(),this.close(),this.focus()))}},"loaded-list":{loaded:function(){var e=this;setTimeout(function(){var t=e.$("filtered-list");t&&document.activeElement==t.$("query-input").$("input")?(e._focusOptions(),t.focus()):e._focusOptions()},1)}}}},filteredList:void 0,loadedList:void 0,_opened:!1,_valueWhenOpened:null,initialize:function(){var e=this,t=this.props,o=t.datalist;o&&!function(){var t=e.ownerComponent||window,n=Function("return this."+o+";");c.define(e,"dataList",function(){return n.call(t)})}();var n=t.viewModel,i=t.viewModelItemSchema;if(n){if(n=Function("return this."+n+";").call(this.ownerComponent||window),!n)throw new TypeError("viewModel is not defined")}else n=new r(null,{indexes:[i.value]});c.define(this,"viewModel",n),this._viewModelItemValueFieldName=i.value,this._viewModelItemTextFieldName=i.text,this._viewModelItemDisabledFieldName=i.disabled,c.define(this,{options:function(){return this.optionElements?w.call(this.optionElements,function(e){return e.$c}):[]},text:function(){var e=this;return this.viewModel.map(function(t){return t[e._viewModelItemTextFieldName]}).join(", ")||this.props.placeholder}})},ready:function(){var e=this;this.optionElements=this.element.getElementsByClassName("opal-select-option");var t=this.props;t.viewModel?this._updateOptions():!function(){var o=t.value,n=void 0;if(o){if(!Array.isArray(o))throw new TypeError("value must be an array");if(o.length)if(t.multiple)n=e.options.filter(function(e){return o.indexOf(e.value)!=-1});else{o=o[0];var i=e.options.find(function(e){return e.value==o});n=i?[i]:[]}else n=[]}else if(t.multiple)n=e.options.filter(function(e){return e.selected});else{var s=e.options.find(function(e){return e.selected});n=s?[s]:[]}n.length&&e.viewModel.addRange(n.map(function(t){var o;return o={},o[e._viewModelItemValueFieldName]=t.value,o[e._viewModelItemTextFieldName]=t.text,o})),o&&e._updateOptions()}()},elementAttached:function(){this.listenTo(this.props,"change:value",this._onPropsValueChange),this.listenTo(this.viewModel,"change",this._onViewModelChange)},elementAttributeChanged:function(e,t,o){"focused"==e&&(o?(this._opened||(this._documentKeyDownListening=this.listenTo(document,"keydown",this._onDocumentKeyDown)),this.focus()):(this._opened||this._documentKeyDownListening.stop(),this.blur()))},_onPropsValueChange:function(e){var t=this,o=e.value,n=this.viewModel;if(o){if(!Array.isArray(o))throw new TypeError("value must be an array");o.length?!function(){var e=t._viewModelItemValueFieldName,i=t._viewModelItemTextFieldName;t.props.multiple?t.options.forEach(function(t){var s=t.value;if(o.indexOf(s)!=-1){if(!n.contains(s,e)){var l;n.add((l={},l[e]=s,l[i]=t.text,l))}}else{var c=n.get(s,e);c&&n.remove(c)}}):(o=o[0],n.length&&o==n.get(0)[e]||!t.options.some(function(t){if(t.value==o){var s;return n.set(0,(s={},s[e]=o,s[i]=t.text,s)),!0}})&&n.length&&n.clear())}():n.clear()}else n.clear()},_onViewModelChange:function(){this._updateOptions()},_updateOptions:function(){var e=this,t=this.viewModel;this.options.forEach(function(o){var n=t.get(o.value,e._viewModelItemValueFieldName);n?(o.selected=!0,o.disabled=n[e._viewModelItemDisabledFieldName]):o.selected=!1})},open:function(){var e=this;if(this._opened)return!1;this._opened=!0,this._valueWhenOpened=this.viewModel.map(function(t){return t[e._viewModelItemValueFieldName]}),this.$("button").check(),this.$("menu").open();var t=this.$("loaded-list");t&&l(function(){t.checkLoading()});var o=this.filteredList;return void 0===o&&(o=this.filteredList=this.$("filtered-list")),o?o.focus():this._focusOptions(),this._documentFocusInListening=this.listenTo(document,"focusin",this._onDocumentFocusIn),this.props.focused||(this._documentKeyDownListening=this.listenTo(document,"keydown",this._onDocumentKeyDown)),!0},close:function(){var e=this;return!!this._opened&&(this._opened=!1,this.$("button").uncheck(),this.$("menu").close(),this._documentFocusInListening.stop(),this.props.focused||this._documentKeyDownListening.stop(),this.props.multiple&&(b(this.viewModel.map(function(t){return t[e._viewModelItemValueFieldName]}),this._valueWhenOpened)||this.emit("change")),!0)},toggle:function(e){return void 0!==e?e?this.open():!this.close():this.open()||!this.close()},_onDocumentFocusIn:function(e){this.element.contains(e.target.parentNode)||this.close()},focus:function(){return this.$("button").focus(),this},blur:function(){return this.$("button").blur(),this},_onDocumentKeyDown:function(e){switch(e.which){case 32:e.preventDefault(),this._opened?this._focused&&this.close():this.open();break;case 38:if(e.preventDefault(),this._opened){if(document.activeElement==document.body)this._focusOptions()&&document.body.classList.remove("_no-focus-highlight");else for(var t=this.options,o=1,n=t.length;o<n;o++)if(t[o].props.focused){do{var i=t[--o];if(!i.props.disabled){document.body.classList.remove("_no-focus-highlight"),i.focus();break}}while(o);break}}else this.open();break;case 40:if(e.preventDefault(),this._opened){if(document.activeElement==document.body)this._focusOptions()&&document.body.classList.remove("_no-focus-highlight");else for(var s=this.options,l=0,c=s.length-1;l<c;l++)if(s[l].props.focused){do{var a=s[++l];if(!a.props.disabled){document.body.classList.remove("_no-focus-highlight"),a.focus();break}}while(l<c);break}}else this.open();break;case 27:e.preventDefault(),this.close(),this.focus()}},_focusOptions:function(){for(var e=this.options,t=void 0,o=0,n=e.length;o<n;o++){var i=e[o];if(!i.props.disabled){if(i.selected){t=i;break}t||(t=i)}}return!!t&&(t.focus(),!0)}})},1:function(t,o){t.exports=e},2:function(e,o){e.exports=t},3:function(e,t){e.exports=o},16:function(e,t){"use strict";function o(e,t){var o=e.length;if(o!=t.length)return!1;for(var n=0;n<o;n++)if(e[n]!==t[n])return!1;return!0}e.exports=o},17:function(e,t,o){"use strict";o(67);var n=o(2),i=o(1),s=i.Component;e.exports=s.extend("opal-select-option",{Static:{props:{value:String,text:{type:String,required:!0},selected:!1,focused:!1,tabIndex:0,disabled:!1},template:o(37),events:{control:{focusin:function(){this.props.focused=!0},focusout:function(){this.props.focused=!1},click:function(){this._click()}}}},initialize:function(){n.define(this,{_tabIndex:function(){return this.props.disabled?-1:this.props.tabIndex}})},ready:function(){var e=this.props;void 0===e.value&&(e.value=e.text)},elementAttributeChanged:function(e,t,o){"focused"==e&&(o?(this._documentKeyDownListening=this.listenTo(document,"keydown",this._onDocumentKeyDown),this.focus()):(this._documentKeyDownListening.stop(),this.blur()))},_onDocumentKeyDown:function(e){13!=e.which&&32!=e.which||(e.preventDefault(),this.props.disabled||this._click())},_click:function(){this.emit(this.toggle()?"select":"deselect")},get value(){var e=this.props;return void 0===e.value?e.text:e.value},set value(e){this.props.value=e},get text(){return this.props.text.trim()||" "},set text(e){this.props.text=e},get selected(){return this.props.selected},set selected(e){this.props.selected=e},get disabled(){return this.props.disabled},set disabled(e){this.props.disabled=e},select:function(){return!this.props.selected&&(this.props.selected=!0,!0)},deselect:function(){return!!this.props.selected&&(this.props.selected=!1,!0)},toggle:function(e){return this.props.selected=void 0===e?!this.props.selected:e},focus:function(){return this.$("control").focus(),this},blur:function(){return this.$("control").blur(),this},enable:function(){return this.props.disabled=!1,this},disable:function(){return this.props.disabled=!0,this}})},36:function(e,t){e.exports='<rt-content select=".opal-select__button"> {{block button }} <opal-button class="opal-select__button" type="{props.type}" size="{props.size}" checkable="" tab-index="{props.tabIndex}" disabled="{props.disabled}"> {{block button_inner }} <template is="rt-if-then" if="props.text" rt-silent="">{props.text}</template> <template is="rt-if-else" if="props.text" rt-silent="">{text}</template> {{block icon_chevron_down }} <svg viewBox="0 0 32 18" class="opal-select__icon-chevron-down"><use xlink:href="#opal-select__icon-chevron-down"></use></svg> {{/block}} {{/block}} </opal-button> {{/block}} </rt-content> <rt-content select=".opal-select__menu"> {{block menu }} <opal-dropdown class="opal-select__menu" auto-closing=""> {{block menu_inner }} <rt-content select=".opal-select__menu-content"> <template is="rt-if-then" if="props.datalist"> <div class="opal-select__menu-content"> <template is="rt-if-then" if="dataList?.length"> <template is="rt-repeat" for="item of dataList"> {{block option }} <opal-select-option value="{item |key(_viewModelItemValueFieldName) }" text="{item |key(_viewModelItemTextFieldName) }"></opal-select-option> {{/block}} </template> {{block new_input_container }} <rt-content class="opal-select__new-input-container" select=".opal-select__new-input">{{block new_input }}{{/block}}</rt-content> {{/block}} </template> <template is="rt-if-else" if="dataList?.length" rt-silent=""> {{block loader }} <opal-loader shown=""></opal-loader> {{/block}} </template> </div> </template> <template is="rt-if-else" if="props.datalist"> <div class="opal-select__menu-content"> {{block options }} <rt-content select="opal-select-option"></rt-content> {{/block}} </div> </template> </rt-content> {{/block}} </opal-dropdown> {{/block}} </rt-content>'},37:function(e,t){e.exports='<span class="opal-select-option__control" tabindex="{_tabIndex}"> <rt-content class="opal-select-option__content">{props.text}</rt-content> </span>'},66:function(e,t){e.exports=function(e){var t=e.head||e.getElementsByTagName("head")[0];if(t){var o=e.createElement("style");return o.type="text/css",o.textContent=".opal-select{position:relative;display:inline-block;vertical-align:middle;line-height:0}.opal-select .opal-select__button{display:block;min-width:100%}.opal-select .opal-select__icon-chevron-down{display:inline-block;margin-left:.25em;width:14px;height:14px;vertical-align:middle;transition:transform .1s linear;fill:currentColor}.opal-select .opal-select__button[size=s] .opal-select__icon-chevron-down{width:12px;height:12px}.opal-select .opal-select__button[checked] .opal-select__icon-chevron-down{-ms-transform:scaleY(-1);transform:scaleY(-1)}.opal-select .opal-select__new-input{display:block;margin:10px;width:auto}.opal-select .opal-popover{padding:6px 0;min-width:100px}.opal-select .opal-filtered-list .opal-filtered-list__query-input{margin:10px}.opal-select .opal-loaded-list{height:300px}",t.appendChild(o),o}return null}(document)},67:function(e,t){e.exports=function(e){var t=e.head||e.getElementsByTagName("head")[0];if(t){var o=e.createElement("style");return o.type="text/css",o.textContent=".opal-select-option{display:block}.opal-select-option .opal-select-option__control{position:relative;display:block;padding:7px 22px;background:#fff;color:#000;text-align:left;text-shadow:none;white-space:nowrap;font:16px/24px Verdana,Geneva,sans-serif;font-weight:400;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}.opal-select-option .opal-select-option__content{position:relative;display:block}.opal-select-option .opal-select-option__control:hover{background:#e6e6e6}.opal-select-option .opal-select-option__control:focus{outline:none}.opal-select-option .opal-select-option__control:focus::after{position:absolute;top:2px;right:2px;bottom:2px;left:2px;box-shadow:inset 0 0 0 1px #33a0ff;content:'';pointer-events:none}.opal-select-option .opal-select-option__control:active{background:#ccc}.opal-select-option[selected] .opal-select-option__control{color:#0d87f2}.opal-select-option[disabled]{opacity:.5;pointer-events:none}.opal-select-option[disabled] .opal-select-option__control{cursor:default}",t.appendChild(o),o}return null}(document)},79:function(e,t){!function e(){document.body?document.body.insertAdjacentHTML("beforeend",'<svg xmlns="http://www.w3.org/2000/svg" style="display:none"><symbol viewBox="0 0 32 18" id="opal-select__icon-chevron-down"><path stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" fill="none" d="M2 2l14 14L30 2"/></symbol></svg>'):setTimeout(e,100)}()}})});